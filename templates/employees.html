{% extends "base.html" %}

{% block title %}Employee Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-users me-2"></i>Employee Management</h2>
            <a href="{{ url_for('admin_dashboard' if session.user_type == 'admin' else 'hr_dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to {{ 'Admin' if session.user_type == 'admin' else 'HR' }}
            </a>
        </div>

        <!-- Add Employee Form -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-user-plus me-2"></i>Add New Employee</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_employee') }}" id="employeeForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Name *</label>
                                <input type="text" class="form-control" id="name" name="name" required
                                       pattern="[A-Za-z ]+" title="Only alphabets and spaces are allowed">
                                <div class="invalid-feedback">Please provide a valid name (letters and spaces only).</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="father_name" class="form-label">Father Name *</label>
                                <input type="text" class="form-control" id="father_name" name="father_name" required
                                       pattern="[A-Za-z ]+" title="Only alphabets and spaces are allowed">
                                <div class="invalid-feedback">Please provide a valid father's name (letters and spaces only).</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="phone_no" class="form-label">Phone Number</label>
                                <input type="text" class="form-control" id="phone_no" name="phone_no"
                                       pattern="[0-9]{10,11}" title="Phone number should be 10-15 digits">
                                <div class="invalid-feedback">Please provide a valid phone number (10-15 digits).</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contractor_id" class="form-label">Contractor</label>
                                <select class="form-control" id="contractor_id" name="contractor_id">
                                    <option value="">Select Contractor</option>
                                    {% for contractor in contractors %}
                                    <option value="{{ contractor[0] }}">{{ contractor[1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="is_active" name="is_active" checked>
                        <label class="form-check-label" for="is_active">Active</label>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Add Employee
                    </button>
                </form>
            </div>
        </div>

        <!-- Employee List -->
        <div class="card shadow">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Employee List</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="activeFilter" checked>
                    <label class="form-check-label" for="activeFilter">Show Active Only</label>
                </div>
            </div>
            <div class="card-body">
                {% if employees %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="employeesTable">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Father Name</th>
                                <th>Phone</th>
                                <th>Address</th>
                                <th>Contractor</th>
                                <th>Status</th>
                                <th>Created By</th>
                                <th>Created At</th>
                                <th>Updated By</th>
                                <th>Updated At</th>
                                <th>Actions</th>
                                
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in employees %}
                            <tr class="{% if not employee[6] %}table-danger inactive-employee{% endif %}">
                                <td>{{ employee[0] }}</td>
                                <td>
                                    <i class="fas fa-user me-1"></i>
                                    {{ employee[1] }}
                                </td>
                                <td>{{ employee[2] }}</td>
                                <td>
                                    {% if employee[3] %}
                                        <i class="fas fa-phone me-1"></i>
                                        {{ employee[3] }}
                                    {% else %}
                                        <span class="text-muted">Not provided</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if employee[4] %}
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        {{ employee[4][:50] }}{% if employee[4]|length > 50 %}...{% endif %}
                                    {% else %}
                                        <span class="text-muted">Not provided</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if employee[5] %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-building me-1"></i>
                                            {{ employee[5] }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">No contractor</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if employee[6] %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>
                                            Active
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times-circle me-1"></i>
                                            Inactive
                                        </span>
                                    {% endif %}
                                </td>
                                <td>{{ employee.CreatedByEmail }}</td>
                                <td>{{ employee.CreatedAt }}</td>
                                <td>{{ employee.UpdatedByEmail if employee.UpdatedByEmail else 'N/A' }}</td>
                                <td>{{ employee.UpdatedAt if employee.UpdatedAt else 'N/A' }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('edit_employee', employee_id=employee[0]) }}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="Edit Employee">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('delete_employee', employee_id=employee[0]) }}" 
                                           class="btn btn-sm btn-outline-danger" 
                                           title="Delete Employee"
                                           onclick="return confirm('Are you sure you want to delete this employee?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No employees found</h5>
                    <p class="text-muted">Add your first employee using the form above.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Employee Statistics -->
{% if employees %}
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Total Employees</h5>
                        <h3>{{ employees|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Active Employees</h5>
                        <h3>{{ employees|selectattr(6)|list|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-check fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>With Contractors</h5>
                        <h3>{{ employees|selectattr(5)|list|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-building fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}


{% block scripts %}
<!-- DataTables CSS and JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css">
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable with proper configuration
    var table = $('#employeesTable').DataTable({
        "pageLength": 10,
        "lengthMenu": [10, 25, 50, 100],
        "stateSave": true,
        "columnDefs": [
            { "orderable": false, "targets": [11] }, // Disable sorting for Actions column
            { "visible": false, "targets": [] } // Hide any columns you don't want visible
        ],
        "createdRow": function(row, data, dataIndex) {
            // Check if the status column (index 6) contains "Inactive"
            if ($('td:eq(6)', row).find('.badge-danger').length > 0) {
                $(row).addClass('inactive-employee');
            }
        }
    });

    // Active/Inactive filter toggle - improved version
    $('#activeFilter').change(function() {
        var showActiveOnly = this.checked;
        
        // Use DataTables API to filter rows
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                var statusCell = table.cell(dataIndex, 6).node();
                var isActive = $(statusCell).find('.badge-success').length > 0;
                return showActiveOnly ? isActive : true;
            }
        );
        
        table.draw();
        
        // Remove the custom filter so it doesn't stack
        $.fn.dataTable.ext.search.pop();
    }).trigger('change'); // Initialize the filter

    // Form validation
    (function() {
        'use strict';
        var form = document.getElementById('employeeForm');
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    })();
});
</script>
{% endblock %}