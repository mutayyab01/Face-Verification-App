{% extends "base.html" %} {% block title %}Employee Management{% endblock %} {%
block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2><i class="fas fa-users me-2"></i>Employee Management</h2>
      <a
        href="{{ url_for('admin_dashboard' if session.user_type == 'admin' else 'hr_dashboard') }}"
        class="btn btn-secondary"
      >
        <i class="fas fa-arrow-left me-1"></i> Back to {{ 'Admin' if
        session.user_type == 'admin' else 'HR' }}
      </a>
    </div>

    <!-- Add Employee Form -->
    <div class="card shadow mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <i class="fas fa-user-plus me-2"></i>Add New Employee
        </h5>
      </div>
      <div class="card-body">
        <form
          method="POST"
          action="{{ url_for('add_employee') }}"
          id="employeeForm"
          enctype="multipart/form-data"
          novalidate
        >
          <div class="row">
            <!-- Nucleus ID -->
            <div class="col-md-6">
              <div class="mb-3">
                <label for="NucleusId" class="form-label">NucleusId *</label>
                <input
                  type="text"
                  class="form-control"
                  id="NucleusId"
                  name="NucleusId"
                  required
                  pattern="^\d+$"
                  title="Only digits are allowed (e.g., 123456)"
                />
                <div class="invalid-feedback">
                  Only digits are allowed. This field is required.
                </div>
              </div>
            </div>

            <!-- Name -->
            <div class="col-md-6">
              <div class="mb-3">
                <label for="Name" class="form-label">Name *</label>
                <input
                  type="text"
                  class="form-control"
                  id="Name"
                  name="Name"
                  required
                  pattern="^[A-Za-z ]+$"
                  title="Only alphabets and spaces are allowed"
                />
                <div class="invalid-feedback">
                  Only letters and spaces allowed. This field is required.
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Father Name -->
            <div class="col-md-6">
              <div class="mb-3">
                <label for="FatherName" class="form-label">Father Name *</label>
                <input
                  type="text"
                  class="form-control"
                  id="FatherName"
                  name="FatherName"
                  required
                  pattern="^[A-Za-z ]+$"
                  title="Only alphabets and spaces are allowed"
                />
                <div class="invalid-feedback">
                  Only letters and spaces allowed. This field is required.
                </div>
              </div>
            </div>

            <!-- Phone Number -->
            <div class="col-md-6">
              <div class="mb-3">
                <label for="PhoneNumber" class="form-label"
                  >Phone Number *</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="PhoneNumber"
                  name="PhoneNumber"
                  required
                  pattern="^\d{10,11}$"
                  title="Enter 10 or 11 digits only"
                />
                <div class="invalid-feedback">
                  Phone number must be 10 digits. No text allowed.
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Address -->
            <div class="col-md-6">
              <div class="mb-3">
                <label for="address" class="form-label">Address</label>
                <textarea
                  class="form-control"
                  id="address"
                  name="address"
                  rows="2"
                  required
                ></textarea>
              </div>
            </div>

            <!-- Contractor -->
            <div class="col-md-6">
              <div class="mb-3">
                <label for="contractor_id" class="form-label"
                  >Contractor *</label
                >
                <select
                  class="form-control"
                  id="contractor_id"
                  name="contractor_id"
                  required
                >
                  <option value="">Select Contractor</option>
                  {% for contractor in contractors %}
                  <option value="{{ contractor[0] }}">
                    {{ contractor[1] }}
                  </option>
                  {% endfor %}
                </select>
                <div class="invalid-feedback">Please select a contractor.</div>
              </div>
            </div>
          </div>

          <!-- File Upload -->
          <div class="row">
            <div class="col-md-12">
              <div class="mb-3">
                <label for="profileImage" class="form-label"
                  >Upload Image *</label
                >
                <input
                  class="form-control form-control-lg"
                  id="profileImage"
                  name="profileImage"
                  type="file"
                  required
                  accept="image/*"
                />
                <div class="invalid-feedback">Please upload an image file.</div>
              </div>
            </div>
          </div>

          <!-- Active Status -->
          <div class="mb-3 form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="is_active"
              name="is_active"
              checked
            />
            <label class="form-check-label" for="is_active">Active</label>
          </div>

          <!-- Submit -->
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i> Add Employee
          </button>
        </form>
      </div>
    </div>

    <!-- Employee List -->
    <div class="card shadow">
      <div
        class="card-header bg-info text-white d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Employee List</h5>
        <div class="form-check form-switch">
          <input
            class="form-check-input"
            type="checkbox"
            id="activeFilter"
            checked
          />
          <label class="form-check-label" for="activeFilter"
            >Show Active Only</label
          >
        </div>
      </div>
      <div class="card-body">
        {% if employees %}
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="employeesTable">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Father Name</th>
                <th>Phone</th>
                <th>Address</th>
                <th>Contractor</th>
                <th>Status</th>
                <th>Created By</th>
                <th>Created At</th>
                <th>Updated By</th>
                <th>Updated At</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              {% for employee in employees %}
              <tr
                class="{% if not employee[6] %}table-danger inactive-employee{% endif %}"
              >
                <!-- NucleusId -->
                <td>{{ employee[0] }}</td>

                <!-- Name -->
                <td>
                  <i class="fas fa-user me-1"></i>
                  {{ employee[1] }}
                </td>

                <!-- Father Name -->
                <td>{{ employee[2] }}</td>

                <!-- Phone Number -->
                <td>
                  {% if employee[3] %}
                  <i class="fas fa-phone me-1"></i>
                  {{ employee[3] }} {% else %}
                  <span class="text-muted">Not provided</span>
                  {% endif %}
                </td>

                <!-- Address -->
                <td>
                  {% if employee[4] %}
                  <i class="fas fa-map-marker-alt me-1"></i>
                  {{ employee[4][:50] }}{% if employee[4]|length > 50 %}...{%
                  endif %} {% else %}
                  <span class="text-muted"> provided</span>
                  {% endif %}
                </td>

                <!-- Contractor -->
                <td>
                  {% if employee[5] %}
                  <span class="badge bg-secondary">
                    <i class="fas fa-building me-1"></i>
                    {{ employee[5] }}
                  </span>
                  {% else %}
                  <span class="text-muted">No contractor</span>
                  {% endif %}
                </td>

                <!-- Status -->
                <td>
                  {% if employee[6] %}
                  <span class="badge bg-success">
                    <i class="fas fa-check-circle me-1"></i>
                    Active
                  </span>
                  {% else %}
                  <span class="badge bg-danger">
                    <i class="fas fa-times-circle me-1"></i>
                    Inactive
                  </span>
                  {% endif %}
                </td>

                <!-- Created By Email -->
                <td>{{ employee[7] }}</td>

                <!-- Created At -->
                <td>{{ employee[8] }}</td>

                <!-- Updated By Email -->
                <td>{{ employee[9] if employee[9] else 'N/A' }}</td>

                <!-- Updated At -->
                <td>{{ employee[10] if employee[10] else 'N/A' }}</td>

                <!-- Profile Image -->
                <td>
                  {% if employee[11] %}
                  <img
                    src="{{ url_for('static', filename='uploads/' ~ employee[11]) }}"
                    alt="Image"
                    width="50"
                    height="50"
                    class="rounded-circle border"
                  />
                  {% else %}
                  <span class="text-muted">No image</span>
                  {% endif %}
                </td>

                <!-- Actions -->
                <td>
                  <div class="btn-group" role="group">
                    <a
                      href="{{ url_for('edit_employee', employee_id=employee[0]) }}"
                      class="btn btn-sm btn-outline-primary"
                      title="Edit Employee"
                    >
                      <i class="fas fa-edit"></i>
                    </a>
                    <a
                      href="{{ url_for('delete_employee', employee_id=employee[0]) }}"
                      class="btn btn-sm btn-outline-danger"
                      title="Delete Employee"
                      onclick="return confirm('Are you sure you want to delete this employee?')"
                    >
                      <i class="fas fa-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-4">
          <i class="fas fa-users fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No employees found</h5>
          <p class="text-muted">
            Add your first employee using the form above.
          </p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Employee Statistics -->
{% if employees %}
<div class="row mt-4">
  <div class="col-md-4">
    <div class="card bg-primary text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h5>Total Employees</h5>
            <h3>{{ employees|length }}</h3>
          </div>
          <div class="align-self-center">
            <i class="fas fa-users fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card bg-success text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h5>Active Employees</h5>
            <h3>{{ employees|selectattr(6)|list|length }}</h3>
          </div>
          <div class="align-self-center">
            <i class="fas fa-user-check fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card bg-warning text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h5>With Contractors</h5>
            <h3>{{ employees|selectattr(5)|list|length }}</h3>
          </div>
          <div class="align-self-center">
            <i class="fas fa-building fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %} {% endblock %} {% block scripts %}
<!-- DataTables CSS and JS -->
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"
/>
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css"
/>
<script
  type="text/javascript"
  src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"
></script>

<script>
  $(document).ready(function () {
    // Initialize DataTable with proper configuration
    var table = $("#employeesTable").DataTable({
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100],
      stateSave: true,
      columnDefs: [
        { orderable: false, targets: [11] }, // Disable sorting for Actions column
        { visible: false, targets: [] }, // Hide any columns you don't want visible
      ],
      createdRow: function (row, data, dataIndex) {
        // Check if the status column (index 6) contains "Inactive"
        if ($("td:eq(6)", row).find(".badge-danger").length > 0) {
          $(row).addClass("inactive-employee");
        }
      },
    });

    // Active/Inactive filter toggle - improved version
    $("#activeFilter")
      .change(function () {
        var showActiveOnly = this.checked;

        // Use DataTables API to filter rows
        $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
          var statusCell = table.cell(dataIndex, 6).node();
          var isActive = $(statusCell).find(".badge-success").length > 0;
          return showActiveOnly ? isActive : true;
        });

        table.draw();

        // Remove the custom filter so it doesn't stack
        $.fn.dataTable.ext.search.pop();
      })
      .trigger("change"); // Initialize the filter

    // Form validation
    (function () {
      "use strict";
      var form = document.getElementById("employeeForm");
      form.addEventListener(
        "submit",
        function (event) {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add("was-validated");
        },
        false
      );
    })();
  });
</script>
{% endblock %}