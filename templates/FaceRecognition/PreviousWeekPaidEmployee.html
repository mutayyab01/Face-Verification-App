{% extends "master.html" %}
{% block title %}Previous Week Paid Employees{% endblock %}
{% block content %}

<style>
    /* --- Extra Styling --- */
    .card {
        border-radius: 15px;
        transition: all 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    .form-label {
        font-weight: 600;
    }

    .form-control {
        border-radius: 10px;
        transition: 0.2s;
    }

    .form-control:focus {
        border-color: #198754;
        box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
    }

    .btn-success {
        border-radius: 10px;
        padding: 10px 20px;
    }

    #resultCard {
        border-top: 4px solid #198754;
    }

    .employee-img {
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: transform 0.3s ease;
    }

    .employee-img:hover {
        transform: scale(1.05);
    }

    .employee-info p {
        margin-bottom: 6px;
        font-size: 15px;
    }

    .employee-info strong {
        color: #0d6efd;
    }

    .no-result {
        text-align: center;
        color: #dc3545;
        font-weight: 600;
        padding: 20px 0;
    }

    .employee-img {
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: transform 0.3s ease;
        max-width: 100%;
        height: auto;
        width: 550px;
        /* <-- increase this */
        height: 350px;
        /* <-- make square */
        object-fit: cover;
    }
</style>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-success">
            <i class="fas fa-users me-2"></i>Previous Week Paid Employees
        </h2>
        <a href="{{ url_for('admin.dashboard' if session.user_type == 'admin' else 'face.dashboard') }}" class="btn btn-outline-secondary rounded-pill px-4">
            <i class="fas fa-arrow-left me-1"></i> Back
        </a>
    </div>

    <!-- Search Card -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-gradient  text-white rounded-top">
            <h5 class="mb-0 fw-semibold">
                <i class="fas fa-search me-2"></i> Search Paid Employee
            </h5>
        </div>
        <div class="card-body bg-light">
            <form id="employeeForm" novalidate>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="LabourId" class="form-label">Labour ID *</label>
                        <input type="text" class="form-control" id="LabourId" placeholder="Enter Labour ID" required />
                    </div>
                    <div class="col-md-4">
                        <label for="Date" class="form-label">Date *</label>
                        <input type="date" class="form-control" id="Date" required />
                    </div>
                    <div class="col-md-4">
                        <label for="Amount" class="form-label">Amount *</label>
                        <input type="text" class="form-control" id="Amount" placeholder="Enter Paid Amount" required />
                    </div>
                </div>

                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-success shadow-sm me-5">
                        <i class="fas fa-check-circle me-1"></i> Fetch Details
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0 d-none" id="resultCard">
        <div class="card-header bg-gradient text-white rounded-top">
            <h5 class="mb-0 fw-semibold">
                <i class="fas fa-info-circle me-2"></i>Employee Payment Details
            </h5>
        </div>
        <div class="card-body bg-white" id="employeeDetails"></div>
    </div>
</div>

<script>
    document.getElementById('employeeForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const LabourId = document.getElementById('LabourId').value.trim();
        const Date = document.getElementById('Date').value.trim();
        const Amount = document.getElementById('Amount').value.trim();

        if (!LabourId || !Date || !Amount) {
            Swal.fire({
                icon: 'warning',
                title: 'Missing Fields',
                text: 'Please fill all fields before searching.',
                confirmButtonColor: '#198754'
            });
            return;
        }

        fetch(`/face/api/PreviousWeekPaidEmployees?LabourId=${LabourId}&Date=${Date}&Amount=${Amount}`, {
            method: 'GET',
            headers: { 'Accept': 'application/json' }
        })
            .then(res => res.json())
            .then(data => {
                const resultCard = document.getElementById('resultCard');
                const detailsDiv = document.getElementById('employeeDetails');
                resultCard.classList.remove('d-none');

                if (data && data.Employee) {
                    detailsDiv.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-5 text-center">
                            <img src="${data.Employee.Image || '/static/img/default-avatar.png'}"
                                alt="Employee Image"
                                class="employee-img mb-3" />
                        </div>
                        <div class="col-md-5 employee-info">
                            <p><strong>Nucleus ID:</strong> ${data.Employee.NucleusId}</p>
                            <p><strong>Labour Name:</strong> ${data.PaymentDetail.LabourName}</p>
                            <p><strong>Contractor Name:</strong> ${data.PaymentDetail.ContractorName}</p>
                            <p><strong>Amount:</strong> <span class="text-success fw-bold">${data.PaymentDetail.Amount}</span></p>
                            <p><strong>Date Paid:</strong> ${data.PaymentDetail.CreatedAt}</p>
                            <p><strong>Status:</strong> 
                                <span id="paymentStatus" class="badge ${data.PaymentDetail.IsPaid ? 'bg-success' : 'bg-danger'}">
                                    ${data.PaymentDetail.IsPaid ? 'Paid' : 'Unpaid'}
                                </span>
                            </p>
                            ${data?.PaymentDetail?.IsPaid === false ? `
                                <div class="text-end mt-3">
                                    <button type="button" id="ConfirmVerifyAndPay" class="btn btn-success shadow-sm me-5" style="position: relative;bottom:100px;">
                                        <i class="fas fa-check-circle me-1"></i> Verify & Pay
                                    </button>
                                </div>` : ``}
                        </div>
                    </div>
                `;

                    // Attach event listener to "Verify & Pay" button (if exists)
                    const payBtn = document.getElementById("ConfirmVerifyAndPay");
                    if (payBtn) {
                        payBtn.addEventListener("click", function () {
                            Swal.fire({
                                title: 'Are you sure?',
                                text: "Do you want to verify and mark this employee as paid?",
                                icon: 'question',
                                showCancelButton: true,
                                confirmButtonColor: '#198754',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Yes, verify & pay',
                                cancelButtonText: 'Cancel'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    Swal.fire({
                                        title: 'Processing...',
                                        text: 'Please wait while we update the payment.',
                                        allowOutsideClick: false,
                                        didOpen: () => Swal.showLoading()
                                    });

                                    fetch(`/face/api/PreviousWeekPaidEmployeesConfirmed?LabourId=${LabourId}&Date=${Date}&Amount=${Amount}`, {
                                        method: "POST",
                                        headers: { "Accept": "application/json" }
                                    })
                                        .then(res => res.json())
                                        .then(response => {
                                            Swal.close();
                                            if (response.status === "success") {
                                                Swal.fire({
                                                    icon: 'success',
                                                    title: 'Payment Confirmed',
                                                    text: 'The employee has been marked as Paid!',
                                                    confirmButtonColor: '#198754'
                                                });

                                                const statusBadge = document.getElementById("paymentStatus");
                                                statusBadge.classList.remove("bg-danger");
                                                statusBadge.classList.add("bg-success");
                                                statusBadge.textContent = "Paid";

                                                payBtn.style.display = "none";
                                                document.getElementById('employeeForm').reset();

                                            } else {
                                                Swal.fire({
                                                    icon: 'error',
                                                    title: 'Failed',
                                                    text: 'Could not update payment. Try again.',
                                                    confirmButtonColor: '#198754'
                                                });
                                            }
                                        })
                                        .catch(err => {
                                            console.error(err);
                                            Swal.close();
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'Error',
                                                text: 'Server error occurred.',
                                                confirmButtonColor: '#198754'
                                            });
                                        });
                                }
                            });
                        });
                    }
                } else {
                    detailsDiv.innerHTML = `
                    <div class="no-result">
                        <i class="fas fa-exclamation-circle me-2"></i>No records found for the given details.
                    </div>
                `;
                }
            })
            .catch(err => {
                console.error(err);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to fetch data. Please try again later.',
                    confirmButtonColor: '#198754'
                });
            });
    });
</script>



{% endblock %}